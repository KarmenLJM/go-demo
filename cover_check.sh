#!/usr/bin/env bash
set -euo pipefail

###############################################################################
# 配置 —— 根据实际情况改端口和启动命令
###############################################################################
APP_PORT=8176                   # 你的服务器监听的端口
APP_CMD=(go run -cover -coverpkg=./... -covermode=atomic .)  # 启动命令

###############################################################################
# 1. 准备绝对、可写的 GOCOVERDIR
###############################################################################
export GOCOVERDIR="$(pwd)/coverdata"
rm -rf  "$GOCOVERDIR"
mkdir -p "$GOCOVERDIR"
chmod 777 "$GOCOVERDIR"

###############################################################################
# 2. 前台启动应用，stderr 记到文件方便分析
###############################################################################
echo -e "\n=== start app ==="
"${APP_CMD[@]}" 2>&1 | tee /tmp/app.stderr &      # 前台 -> 能实时看到 panic/报错
PID=$!
echo "PID=$PID   GOCOVERDIR=$GOCOVERDIR"
sleep 2           # 等初始化

###############################################################################
# 3. 确认进程里有没有 GOCOVERDIR
###############################################################################
echo -e "\n=== /proc/$PID/environ (grep GOCOVERDIR) ==="
if ! tr '\0' '\n' < /proc/$PID/environ | grep -q "^GOCOVERDIR=$GOCOVERDIR$"; then
    echo "❌  进程根本没拿到 GOCOVERDIR —— 覆盖率被 runtime 整体关闭"
    kill $PID; exit 1
fi
echo "✓ 进程环境正确"

###############################################################################
# 4. 看刚启动时 stderr 里有没有覆盖率相关报错
###############################################################################
echo -e "\n=== coverage 关键字搜索 stderr ==="
grep -i coverage /tmp/app.stderr || echo "(没有任何 coverage 报错)"

###############################################################################
# 5. 触发一次业务路径，保证代码执行
###############################################################################
curl -sf "http://127.0.0.1:${APP_PORT}/hello" >/dev/null || true

###############################################################################
# 6. 目录里现有的覆盖率文件
###############################################################################
echo -e "\n=== content of $GOCOVERDIR ==="
ls -l "$GOCOVERDIR" || true

###############################################################################
# 7. 拉实时覆盖率
###############################################################################
echo -e "\n=== /debug/pprof/coverage?format=text (前 20 行) ==="
curl -s "http://127.0.0.1:${APP_PORT}/debug/pprof/coverage?format=text" | head -n 20 || true

kill $PID